# Changelog

All notable changes to DB-Hive will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- **Add Row Functionality**:
  - "Add Row" button in table toolbar (visible only in edit mode)
  - New rows rendered at top of table with green visual indicator
  - Remove button (X) to delete new rows before commit
  - Smart auto-generation detection for id, created_at, updated_at columns
  - INSERT statement generation with proper NULL handling
  - Transaction support for mixed INSERT + UPDATE operations
- **Table Metadata Enhancements**:
  - Added `isAutoIncrement` field to `ColumnInfo` type for accurate auto-increment detection
  - PostgreSQL: Row count display in sidebar using `pg_class.reltuples` statistics
  - PostgreSQL: Column headers now visible for empty tables via prepared statement metadata
  - MySQL: Improved UUID column type detection using `COLUMN_TYPE` instead of `DATA_TYPE`

### Changed
- Increased table result limit from 20 to 35 rows per page
- Improved post-commit UX: "Review Changes" button now clears properly after commit
- **Transaction Preview UX**: New rows remain visible with green highlighting when "Review Changes" is opened

### Fixed
- **Auto-increment detection (Critical)**:
  - MySQL: Now reads `EXTRA` column to detect `AUTO_INCREMENT` attribute
  - PostgreSQL: Detects `SERIAL` types and `nextval()` in default values
  - SQLite: Detects `INTEGER PRIMARY KEY` and `AUTOINCREMENT` keyword
  - MongoDB: `_id` field correctly marked as auto-increment
  - Frontend now checks `isAutoIncrement` field first before fallback heuristics
- **UUID primary key handling (Critical)**:
  - UUID columns without database defaults now have UUIDs auto-generated in the application
  - Uses `crypto.randomUUID()` to generate RFC 4122 compliant v4 UUIDs
  - Only skips UUID columns if database has UUID generation function (e.g., `DEFAULT UUID()`)
  - Prevents "cannot be null" errors for UUID primary keys
- **Timestamp column handling (Critical)**:
  - Timestamp columns (`created_at`, `updated_at`) without defaults now have timestamps auto-generated
  - Uses `new Date().toISOString()` to generate current timestamp in SQL format
  - Only skips timestamp columns if database has default (e.g., `DEFAULT CURRENT_TIMESTAMP`)
  - Prevents "cannot be null" errors for required timestamp columns
- Auto-generated columns (id, created_at, updated_at) no longer cause "cannot be null" errors
- New rows now skip auto-increment and auto-timestamp columns in INSERT statements
- PostgreSQL boolean values now correctly generate unquoted literals (true/false instead of 'true'/'false')
- PostgreSQL tables now show row counts in sidebar (previously showed nothing)
- PostgreSQL empty tables now display column headers (previously showed blank headers)
- MySQL row counts now accurate (previously some tables showed 0 incorrectly)
- Transaction preview table now has checkbox column header (previously misaligned)
- New rows now visible in transaction preview panel (previously disappeared)
- discardChanges() now clears both cell edits and new rows

### Technical Details

#### Type System Changes
- Added `isAutoIncrement: boolean` field to `ColumnInfo` interface (`src/types/database.ts`)
- Updated Rust `ColumnInfo` struct with `is_auto_increment` field (`src-tauri/src/models/metadata.rs`)

#### Backend Driver Changes
- **MySQL Driver** (`src-tauri/src/drivers/mysql.rs`):
  - Now reads `EXTRA` column from `information_schema.COLUMNS`
  - Sets `is_auto_increment = true` when EXTRA contains "auto_increment"
  - Changed UUID detection to use `COLUMN_TYPE` instead of `DATA_TYPE` for full type info
- **PostgreSQL Driver** (`src-tauri/src/drivers/postgres.rs`):
  - Detects `SERIAL`/`BIGSERIAL`/`SMALLSERIAL` types in data_type field
  - Detects `nextval()` and `sequence` in column default values for proper SERIAL detection
  - Enhanced detection logic to handle all PostgreSQL auto-increment patterns
  - Added row count fetching using `pg_class.reltuples` statistics
  - Fixed empty table column header extraction using prepared statements
- **SQLite Driver** (`src-tauri/src/drivers/sqlite.rs`):
  - Detects `INTEGER PRIMARY KEY` (implicit autoincrement in SQLite)
  - Detects `AUTOINCREMENT` keyword in data type
- **MongoDB Driver** (`src-tauri/src/drivers/mongodb.rs`):
  - Marks `_id` field as auto-increment (ObjectId auto-generated by MongoDB)

#### Frontend/Hook Changes
- Enhanced `useTableEditor` hook (`src/hooks/useTableEditor.ts`):
  - Added `NewRow` interface and state management for new rows
  - Implemented `addRow()`, `removeNewRow()`, and `updateNewRowValue()` functions
  - **Enhanced `shouldSkipColumnInInsert()`**:
    - Now checks `col.isAutoIncrement` field FIRST (most reliable)
    - UUID primary keys now only skipped if they have database default value
    - Timestamp columns now only skipped if they have database default value
    - Checks for CURRENT_TIMESTAMP, now(), getdate(), and other timestamp functions
    - Removed redundant primary key + numeric type check (now handled by backend)
  - **Enhanced `generateInsertStatements()`** with auto-generation:
    - Auto-generates UUIDs using `crypto.randomUUID()` for UUID columns without values
    - Auto-generates timestamps using `new Date().toISOString()` for timestamp columns
    - Smart column detection and proper type handling
    - Generates RFC 4122 compliant v4 UUIDs and SQL-formatted timestamps
  - Enhanced `generateUpdateStatements()` with proper boolean value formatting
  - Updated `discardChanges()` to clear new rows
  - Updated `getCellValue()` and `applyChange()` to handle negative row indices
  - Added comprehensive debug logging throughout INSERT generation
  - Fixed value formatting: booleans unquoted, strings quoted, numbers unquoted

#### Frontend UI Changes
- Updated `TableInspector.tsx`:
  - Added "Add Row" button in toolbar
  - Increased pageSize from 20 to 35 rows per page
  - Rendered new rows at top with green styling and remove buttons
  - Updated handleCommit to include INSERT statements
  - Enhanced TransactionPreview to show INSERT + UPDATE statements
  - **Fixed transaction preview table structure**:
    - Added checkbox column header in both table views (with/without row viewer)
    - Added checkbox cells for existing rows in all table views
    - Removed `editMode &&` condition from new row rendering (now always visible when present)
    - Fixed "Select All" checkbox to use `selectAll()` with no arguments
  - Added comprehensive debug logging in commit flow

#### Auto-Generation Detection Logic
- **Primary**: Checks `isAutoIncrement` field from backend drivers
- **Fallback heuristics**:
  - Detects columns with function defaults (uuid_generate, gen_random_uuid, current_timestamp, now(), getdate())
  - Skips UUID/GUID primary keys (char/varchar columns named id, uuid, guid, *_id)
  - Skips created_at/updated_at timestamp columns
- Handles integer auto-increment (MySQL AUTO_INCREMENT, PostgreSQL SERIAL, SQLite INTEGER PRIMARY KEY)
- Handles UUID primary keys with auto-generation functions
- Handles MongoDB ObjectId auto-generation

## [0.4.0] - 2025-11-20

### Added

#### Table Editor - Bulk Operations & Enhanced Transaction Preview

- **Row Selection with Checkboxes**:
  - Checkbox column in edit mode for multi-row selection
  - Select all checkbox in table header
  - Individual row checkboxes with visual feedback (highlighted rows)
  - Selection count badge in toolbar
  - Selection state management (toggle, select all, clear)

- **Bulk Delete Functionality**:
  - "Delete Selected" button (appears when rows are selected)
  - Confirmation dialog with row count and warning message
  - Transaction-based bulk deletion using primary keys
  - Database-specific DELETE transaction syntax
  - Auto-refresh after successful deletion
  - Error handling with detailed feedback

- **Enhanced Transaction Preview**:
  - **SQL Syntax Highlighting**:
    - Keywords (UPDATE, SET, WHERE, etc.) - blue/bold
    - String literals - orange
    - Numbers - green
    - Operators - default color
  - **Statistics Display**:
    - Modified rows count with database icon
    - Changed cells count with edit icon
    - Operation breakdown badges (UPDATE/INSERT/DELETE counts)
  - **Statement Type Badges**:
    - Color-coded badges per statement (UPDATE=blue, INSERT=green, DELETE=red)
    - Visual statement numbering
    - Improved readability with better formatting

- **New UI Components**:
  - Created `Checkbox` component using Radix UI primitives
  - AlertDialog for bulk delete confirmation

### Technical Details

#### Backend Changes
- Enhanced `useTableEditor` hook (`src/hooks/useTableEditor.ts`):
  - Added `generateDeleteStatements()` function
  - DELETE statement generation using primary key WHERE clauses
  - NULL value handling in WHERE clauses
  - Database identifier quoting support

#### Frontend Changes
- Updated `TransactionPreview.tsx`:
  - Added `highlightSQL()` function for syntax highlighting
  - New props: `totalChanges`, `modifiedRows`
  - Statistics bar with operation breakdown
  - Statement type detection and badge coloring

- Updated `TableInspector.tsx`:
  - Checkbox column header with select all functionality
  - Checkbox cells for individual row selection
  - Bulk delete handler with transaction support
  - AlertDialog for delete confirmation
  - Selection state tracking and visual feedback
  - Database-specific DELETE transaction syntax

- Created `checkbox.tsx`:
  - Radix UI checkbox primitive wrapper
  - Accessible with ARIA labels
  - Styled with Tailwind classes

#### New Dependencies
- `@radix-ui/react-checkbox@1.3.3`

### Changed
- Table rows in edit mode now show checkboxes before row numbers
- Selected rows have distinct background color (`bg-muted`)
- Toolbar dynamically shows selection count and delete button in edit mode

## [0.3.1] - 2025-11-20

### Fixed

#### Table Editor Critical Fixes
- **Fixed table editor cell editing functionality**:
  - Removed automatic cell copy functionality that was causing toast spam
  - Fixed EditableCell component not showing input field on double-click
  - Added `stopPropagation()` to prevent event bubbling to parent handlers
  - Fixed main table section missing edit mode logic (line 904+ section)
  - Enabled manual text selection for copying cell values

- **Fixed transaction commit for multi-statement SQL**:
  - PostgreSQL driver now uses `batch_execute()` for transactions
  - Added multi-statement SQL detection (counting semicolons)
  - Transactions like `BEGIN; UPDATE ...; COMMIT;` now execute correctly
  - Previously failed with "Query execution failed: db error"

- **Database-specific transaction syntax support**:
  - PostgreSQL: `BEGIN; ... COMMIT;`
  - MySQL: `START TRANSACTION; ... COMMIT;`
  - SQLite: `BEGIN TRANSACTION; ... COMMIT;`
  - MongoDB: Table editing not supported (proper error message)

- **Improved error logging**:
  - Console now shows exact SQL that failed during commit
  - Better error messages for debugging transaction issues

### Technical Details

#### Backend Changes
- Enhanced `execute_query()` in `src-tauri/src/drivers/postgres.rs`:
  - Detects multi-statement SQL by counting semicolons
  - Routes multi-statement SQL to `batch_execute()`
  - Keeps original `query()`/`execute()` logic for single statements
  - Returns empty `QueryResult` for batch operations

#### Frontend Changes
- Updated `TableInspector.tsx`:
  - Removed `copyCellValue()` function and all references
  - Added edit mode logic to main table (previously missing)
  - Fixed row number cells to only open JSON viewer when not in edit mode
  - Added database-specific transaction syntax
  - Enhanced error logging with SQL output
- Updated `EditableCell.tsx`:
  - Added `e.stopPropagation()` in `handleDoubleClick()`
  - Changed cursor from `cursor-pointer` to `cursor-text select-text`

## [0.3.0] - 2025-11-20

### Added

#### Advanced SQL Autocomplete
- **Metadata Caching System**:
  - Intelligent metadata cache with 5-minute expiration
  - Caches databases, schemas, tables, and columns per connection
  - Manual refresh capability via toolbar button
  - Automatic cache invalidation on stale data

- **Context-Aware SQL Suggestions**:
  - **Table suggestions** after `FROM`, `JOIN`, `INTO`, `UPDATE` keywords
  - **Column suggestions** after `SELECT`, `WHERE`, `ON`, `SET`, `GROUP BY`, `ORDER BY`
  - **50+ SQL keywords** (SELECT, FROM, WHERE, JOIN, INSERT, etc.)
  - **40+ SQL functions** (COUNT, SUM, AVG, CONCAT, DATE functions, etc.)
  - Database and schema name suggestions

- **Monaco Editor Integration**:
  - Real-time autocomplete with `Ctrl+Space`
  - Context-sensitive suggestions based on SQL syntax
  - Refresh icon in editor toolbar for metadata updates
  - Proper disposal and re-registration on metadata changes

- **New Tauri Command**: `get_autocomplete_metadata`
  - Returns flattened metadata optimized for autocomplete
  - Supports force refresh parameter
  - Works with all database types (PostgreSQL, MySQL, SQLite, MongoDB)

### Fixed
- JSON syntax highlighting in ResultsViewer and RowJsonViewer
  - Fixed HTML class names appearing in JSON output (e.g., `-400">`)
  - Switched from Tailwind classes to inline styles
  - Added proper HTML escaping to prevent XSS
  - Improved regex patterns to avoid false matches
- TypeScript linting errors in JSON syntax highlighting
- Unused import warnings in frontend components

### Technical Details

#### Backend Changes
- New `MetadataCache` struct in `src-tauri/src/state/mod.rs`
- Enhanced `get_autocomplete_metadata` command in `src-tauri/src/commands/schema.rs`
- Added `metadata_cache` field to `AppState` for per-connection caching

#### Frontend Changes
- New hook: `src/hooks/useAutocompleteMetadata.ts`
- New utility: `src/lib/sqlAutocomplete.ts` (Monaco provider)
- Enhanced `SQLEditor` component with autocomplete integration
- Updated `QueryPanel` to pass database context to editor
- Fixed JSON highlighting in both viewers with inline styles

## [0.3.0] - 2025-11-20

### Added

#### SSH Tunneling Infrastructure (WIP)
- SSH tunnel manager architecture and data models
- Enhanced SSH configuration with flexible authentication methods:
  - Password-based authentication support
  - Private key authentication support
  - Configurable local port binding
- SSH tunnel lifecycle management structure
- Integration with application state management
- Dependencies added: `russh = "0.45"`, `russh-keys = "0.45"`, `dirs = "5.0"`

**Note**: Full SSH tunneling implementation is in progress. The infrastructure and APIs are in place, but the actual tunnel creation and port forwarding will be completed in the next release.

### Fixed
- TypeScript linting errors in JSON syntax highlighting
- Unused import warnings in frontend components

### Technical Details

#### Backend Changes
- New SSH module at `src-tauri/src/ssh/mod.rs` with tunnel manager stub
- Enhanced `SshConfig` model with `SshAuthMethod` enum and authentication options
- Added `SshTunnelManager` to `AppState` for centralized SSH tunnel management
- Updated Cargo dependencies for SSH support

#### Frontend Changes
- Fixed unused parameters in `ResultsViewer.tsx` and `RowJsonViewer.tsx`
- Removed unused `ScrollArea` import

### Known Limitations
- SSH tunneling feature not yet fully functional (infrastructure only)
- MongoDB aggregation pipeline builder UI not yet implemented
- SQL Server driver not yet implemented

## [0.2.0] - 2025-11-20

### Added

#### MongoDB Support
- MongoDB database driver with full CRUD operations support
- MongoDB query parser supporting JavaScript-like syntax:
  - `db.collection.find({...})` - Query documents
  - `db.collection.findOne({...})` - Query single document
  - `db.collection.insertOne({...})` / `insertMany([...])` - Insert documents
  - `db.collection.updateOne/updateMany(filter, update)` - Update documents
  - `db.collection.deleteOne/deleteMany({...})` - Delete documents
  - `db.collection.aggregate([...])` - Run aggregation pipelines
- MongoDB metadata support:
  - List databases
  - List collections (shown as tables)
  - Schema inference from sample documents
  - BSON to JSON conversion for data display
- Optional authentication for local MongoDB instances
- Connection string builder with `authSource=admin` support

#### UI/UX Improvements
- Password visibility toggle in connection form (eye/eye-off icon)
- JSON syntax highlighting in:
  - JSON Row Viewer with color-coded tokens
  - Results Viewer JSON tab with color-coded tokens
- Cell content truncation at 100 characters with tooltips showing full content
- Empty state messages for tables and query results:
  - "No data found in this table" for empty collections/tables
  - "No results returned" for successful queries with no rows
- Improved MongoDB username/password validation (both fields now optional)

### Changed
- Connection form validation now allows optional username/password for MongoDB
- TableInspector now detects MongoDB driver and uses MongoDB query syntax
- Database switching now supports MongoDB in addition to PostgreSQL, MySQL, and SQLite
- ResultsViewer cell rendering now truncates long values for better readability

### Fixed
- MongoDB authentication issues with remote servers (added `authSource=admin` parameter)
- Local MongoDB connections no longer require username/password
- JSON Row Viewer scrolling functionality restored
- Cell content overflow in both TableInspector and ResultsViewer

### Technical Details

#### New Dependencies
- `mongodb = "3.1.0"` - Official MongoDB Rust driver
- `futures-util = "0.3"` - Async stream utilities for MongoDB cursors

#### Backend Changes
- New MongoDB driver implementation at `src-tauri/src/drivers/mongodb.rs` (459 lines)
- Enhanced connection commands to support MongoDB driver type
- MongoDB-specific connection string builder with conditional authentication
- BSON document to JSON conversion utilities

#### Frontend Changes
- Enhanced `ConnectionForm.tsx` with password toggle and MongoDB validation
- Updated `TableInspector.tsx` with MongoDB query support and empty states
- Updated `ResultsViewer.tsx` with cell truncation and empty states
- Enhanced `RowJsonViewer.tsx` with syntax highlighting

### Known Limitations
- MongoDB aggregation pipeline builder UI not yet implemented
- SQL Server driver not yet implemented
- SSH tunneling not yet supported
- MongoDB pagination not yet implemented

## [0.1.0-mvp] - 2025-11-19

### Added

#### Database Support
- PostgreSQL database driver with full connection and metadata support
- MySQL/MariaDB database driver with connection handling
- SQLite database driver for local database management
- Connection management (create, edit, delete, test connections)
- Password persistence using Tauri plugin-store
- Database-specific SQL identifier quoting (backticks for MySQL, double quotes for PostgreSQL/SQLite)

#### SQL Editor
- Monaco Editor integration with SQL syntax highlighting
- Execute single or multiple SQL statements
- Query execution with Ctrl+Enter keyboard shortcut
- Support for SELECT, INSERT, UPDATE, DELETE, and DDL statements
- Execution time display for all queries
- Multi-cursor editing and find/replace

#### Schema Browser
- Browse databases, schemas, and tables
- Database dropdown to switch between databases
- Table list with schema information
- Table Inspector with three tabs:
  - Data tab: Sample data with pagination (20 rows per page)
  - Columns tab: Column definitions, data types, nullability, defaults
  - Indexes tab: Index information with unique and primary key indicators
- Right-click context menus on tables:
  - Generate SELECT query
  - Generate INSERT template
  - Copy table name
  - Refresh table data

#### Results Viewer
- Multiple view modes:
  - Grid view with sortable columns
  - JSON view with pretty-printing
  - Raw view with tab-delimited text
- Click-to-copy functionality:
  - Copy cell values
  - Copy entire rows (tab-separated)
  - Copy entire columns (newline-separated)
- NULL value indicators
- Export results to CSV or JSON
- Row count and execution time display

#### Query Management
- Automatic query history saving
- Search through query history
- Query snippets management:
  - Create snippets from current query
  - Load snippets into editor
  - Delete snippets
  - Snippet descriptions

#### UI/UX
- Dark/Light/System theme support
- Theme toggle in top-right corner
- Toast notifications for user feedback (using Sonner)
- Loading states with skeleton components
- Error boundary for graceful error handling
- Responsive layout with resizable panels
- Welcome screen with DB-Hive logo
- Connection form with validation

### Fixed
- Connection editing bug where updating a profile returned "duplicate ID" error
- Form data not updating when switching between profiles for editing
- Toast notifications now follow the selected theme mode
- Alert dialogs replaced with toast notifications for better UX

### Technical Details

#### Frontend Stack
- React 19 with TypeScript
- Tauri 2.0 for native functionality
- Monaco Editor for SQL editing
- TanStack Table v8 for virtualized data grids
- shadcn/ui + TailwindCSS for styling
- Sonner for toast notifications
- Vite for build tooling

#### Backend Stack
- Rust with Tokio async runtime
- tokio-postgres for PostgreSQL
- mysql_async for MySQL/MariaDB
- rusqlite for SQLite
- tauri-plugin-store for persistence
- serde for serialization

#### Architecture
- Multi-process design (Rust core + React WebView)
- IPC communication via Tauri commands and events
- State management with Mutex<AppState>
- Async operations throughout

### Documentation
- Comprehensive README.md with feature list, installation, and usage
- USER_GUIDE.md with step-by-step tutorials (533 lines)
- Implementation roadmap tracking development progress
- Architecture documentation in CLAUDE.md
- E2E test report template with 62 test cases

### Known Limitations
- MongoDB and SQL Server drivers not yet implemented
- SSH tunneling not yet supported
- Advanced SQL autocomplete not yet implemented
- Table data editing not yet supported
- No query plan visualizer
- No ER diagram generator

### Security Notes
- Passwords currently stored in plaintext in persistent store (temporary solution)
- Future releases will use OS keyring for secure password storage
- All user input is validated before SQL execution
- No SQL injection vulnerabilities detected

---

## Upcoming in v0.2.0

### Planned Features
- MongoDB database driver
- SQL Server database driver
- SSH tunneling support
- Advanced SQL autocomplete with metadata
- Table data inline editing
- Query plan visualizer for PostgreSQL
- ER diagram generator
- Plugin system

For detailed roadmap, see [docs/implementation-roadmap.md](docs/implementation-roadmap.md).

---

**Legend:**
- `Added` - New features
- `Changed` - Changes in existing functionality
- `Deprecated` - Soon-to-be removed features
- `Removed` - Removed features
- `Fixed` - Bug fixes
- `Security` - Security improvements
